<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  </head>
  <body>
    <%- include('./error_messages'); %>
    <%- include('./header'); %>

    <% if(isAuth) { %>
      <div class="main-container">
        <!-- å·¦å´ã®ãƒ‘ãƒãƒ«: ã‚¿ã‚¹ã‚¯ä¸€è¦§ã¨è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="left-panel">
          <div class="greet">
            <h1>ã‚ˆã†ã“ãã€<%= username %>ã•ã‚“ï¼</h1>
            <h1>ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã‚ˆã†ï¼</h1>
          </div>
          <div class="task-add-section">
            <form action="/" method="post">
              <label>ã‚¿ã‚¹ã‚¯ã®è¿½åŠ </label>
              <input required type="text" name="add" placeholder="ä½•ã‚’ã™ã‚‹ï¼Ÿ"/>
              <input type="datetime-local" name="duedatetime" placeholder="æœŸé™"><br>
              <input type="text" name="description" placeholder="èª¬æ˜ã‚’è¿½åŠ ">
              <input type="submit" value="è¿½åŠ "/>
            </form>
          </div>
          <div class="task-list-section">
            <ul id="all-tasks-list">
              <% for(let todo of todos){ %>
                <li class="todo-item <%= todo.done === 1 ? 'completed-task' : '' %>
                                  <%= todo.isOverdue ? 'overdue-task' : '' %>
                                  <%= todo.isDueSoon ? 'due-soon-task' : '' %>"
                    data-task-id="<%= todo.id %>"
                    data-task-content="<%= todo.content %>"
                    data-task-is-due-soon="<%= todo.isDueSoon %>"
                    data-task-is-overdue="<%= todo.isOverdue %>"
                    data-due-date="<%= todo.duedatetime ? new Date(todo.duedatetime).toISOString().split('T')[0] : '' %>"
                    data-is-completed="<%= todo.done === 1 %>">
                  <!-- ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’doneã®å€¤ã§åˆ‡ã‚Šæ›¿ãˆã‚‹ -->
                  <% if (todo.done === 0) { %>
                    <!-- æœªå®Œäº†ã®å ´åˆ: å®Œäº†ãƒœã‚¿ãƒ³ -->
                    <form action="/tasks/complete/<%= todo.id %>" method="POST" class="todo-action-form">
                      <button type="submit" class="todo-action-button complete-btn">
                        å®Œäº†
                      </button>
                    </form>
                  <% } else if (todo.done === 1) { %>
                    <!-- å®Œäº†æ¸ˆã¿ã®å ´åˆ: æˆ»ã™ãƒœã‚¿ãƒ³ -->
                    <form action="/tasks/revert/<%= todo.id %>" method="POST" class="todo-action-form">
                      <button type="submit" class="todo-action-button revert-btn">
                        æˆ»ã™
                      </button>
                    </form>
                  <% } %>

                  <!-- ã‚¿ã‚¹ã‚¯ã®å†…å®¹ (ä¸­å¤®) -->
                  <div class="todo-content">
                      <span><%= todo.content %></span>
                      <% if (todo.duedatetime_formatted) { %>
                          <p class="duedate <%= todo.isOverdue ? 'overdue-text' : '' %>
                                          <%= todo.isDueSoon ? 'due-soon-text' : '' %>">
                              <% if (todo.isOverdue) { %>
                                  <i class="fas fa-exclamation-triangle warning-icon"></i> <!-- æœŸé™åˆ‡ã‚Œã‚¢ã‚¤ã‚³ãƒ³ -->
                              <% } else if (todo.isDueSoon) { %>
                                  <i class="fas fa-clock warning-icon"></i> <!-- æœŸé™é–“è¿‘ã‚¢ã‚¤ã‚³ãƒ³ -->
                              <% } %>
                              æœŸé™: <%= todo.duedatetime_formatted %>
                          </p>
                      <% } %>
                      <% if (todo.description) { %>
                          <p><%= todo.description %></p>
                      <% } %>
                  </div>

                  <!-- å³å´ã®ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ -->
                  <form action="/tasks/delete/<%= todo.id %>" method="POST" class="todo-action-form">
                      <button type="submit" class="todo-action-button delete-btn">
                          å‰Šé™¤
                      </button>
                  </form>
                </li>
              <% } %>
            </ul>
          </div>
        </div>

        <!-- å³å´ã®ãƒ‘ãƒãƒ«: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã®ã‚¿ã‚¹ã‚¯ -->
        <div class="right-panel">
          <div class="calendar-container">
            <div class="calendar-header">
              <button id="prevMonth" class="calendar-nav-btn"><i class="fas fa-chevron-left"></i></button>
              <h2 id="currentMonthYear"></h2>
              <button id="nextMonth" class="calendar-nav-btn"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-weekdays">
              <div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
            </div>
            <div id="calendarGrid" class="calendar-grid">
              <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã¯JavaScriptã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </div>
          </div>

          <div class="selected-date-tasks-container">
            <h3 id="selectedDateHeader"></h3>
            <ul id="selectedDateTasksList">
              <!-- é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã®ã‚¿ã‚¹ã‚¯ã¯JavaScriptã§è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </ul>
            <p id="noTasksMessage" class="no-tasks-message" style="display: none;">ã“ã®æ—¥ã«ã¯ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          </div>
        </div>
      </div>
    <% } else { %>
      <!-- ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã®ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚·ãƒ³ãƒ—ãƒ«ã« -->
      <div class="container text-center mt-5">
        <h1>ToDoã‚¢ãƒ—ãƒªã¸ã‚ˆã†ã“ãï¼</h1>
        <p class="lead">ã‚¿ã‚¹ã‚¯ã‚’ç®¡ç†ã—ã¦ã€æ—¥ã€…ã®ç”Ÿç”£æ€§ã‚’å‘ä¸Šã•ã›ã¾ã—ã‚‡ã†ã€‚</p>
        <p>ä»Šã™ãã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã€å§‹ã‚ã¾ã—ã‚‡ã†ï¼</p>
      </div>
    <% } %>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // --- é€šçŸ¥æ©Ÿèƒ½ã®JavaScript (æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰) ---
        const NOTIFICATION_HISTORY_KEY = 'todo_notification_history';

        function getNotificationHistory() {
          try {
            const history = localStorage.getItem(NOTIFICATION_HISTORY_KEY);
            return history ? JSON.parse(history) : {};
          } catch (e) {
            console.error('Failed to parse notification history from localStorage:', e);
            return {};
          }
        }

        function saveNotificationHistory(history) {
          try {
            localStorage.setItem(NOTIFICATION_HISTORY_KEY, JSON.stringify(history));
          } catch (e) {
            console.error('Failed to save notification history to localStorage:', e);
          }
        }

        function sendNotification(taskId, title, body) {
          if (!("Notification" in window)) {
            console.warn("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
            return;
          }

          if (Notification.permission === "default") {
            Notification.requestPermission().then(permission => {
              if (permission === "granted") {
                new Notification(title, { body: body, icon: '/images/todo-icon.png' });
                markTaskAsNotified(taskId);
              } else {
                console.warn("ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚");
              }
            });
          } else if (Notification.permission === "granted") {
            new Notification(title, { body: body, icon: '/images/todo-icon.png' });
            markTaskAsNotified(taskId);
          } else {
            console.warn("ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          }
        }

        function markTaskAsNotified(taskId) {
          const history = getNotificationHistory();
          history[taskId] = true;
          saveNotificationHistory(history);
        }

        function hasTaskBeenNotified(taskId) {
          const history = getNotificationHistory();
          return history[taskId] === true;
        }

        function checkAndNotifyTasks() {
          const taskItems = document.querySelectorAll('li.todo-item');
          taskItems.forEach(item => {
            const taskId = item.dataset.taskId;
            const taskContent = item.dataset.taskContent;
            const isDueSoon = item.dataset.taskIsDueSoon === 'true';
            const isOverdue = item.dataset.taskIsOverdue === 'true';
            const isCompleted = item.dataset.isCompleted === 'true'; // datasetã‹ã‚‰å–å¾—

            if (isCompleted || hasTaskBeenNotified(taskId)) {
              return;
            }

            let notificationTitle = '';
            let notificationBody = '';

            if (isOverdue) {
              notificationTitle = 'ğŸš¨ æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ï¼';
              notificationBody = `ã€Œ${taskContent}ã€ã®æœŸé™ãŒéãã¦ã„ã¾ã™ï¼`;
              sendNotification(taskId, notificationTitle, notificationBody);
            } else if (isDueSoon) {
              notificationTitle = 'â° æœŸé™é–“è¿‘ã®ã‚¿ã‚¹ã‚¯';
              notificationBody = `ã€Œ${taskContent}ã€ã®æœŸé™ãŒ24æ™‚é–“ä»¥å†…ã§ã™ã€‚`;
              sendNotification(taskId, notificationTitle, notificationBody);
            }
          });
        }
        // --- é€šçŸ¥æ©Ÿèƒ½ã®JavaScript çµ‚ã‚ã‚Š ---


        // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½ã®JavaScript ---
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const selectedDateHeader = document.getElementById('selectedDateHeader');
        const selectedDateTasksList = document.getElementById('selectedDateTasksList');
        const noTasksMessage = document.getElementById('noTasksMessage');
        const allTasksList = document.getElementById('all-tasks-list'); // å…¨ã‚¿ã‚¹ã‚¯ã®ULè¦ç´ 

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null; // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ (YYYY-MM-DDå½¢å¼)

        // å…¨ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— (LIè¦ç´ ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å±æ€§ã‚’èª­ã¿è¾¼ã‚€)
        const allTasksData = Array.from(allTasksList.children).map(li => {
            return {
                id: li.dataset.taskId,
                content: li.dataset.taskContent,
                dueDate: li.dataset.dueDate, // YYYY-MM-DDå½¢å¼
                isCompleted: li.dataset.isCompleted === 'true',
                html: li.outerHTML // LIè¦ç´ å…¨ä½“ã®HTMLã‚’ä¿å­˜
            };
        });

        function generateCalendar() {
            calendarGrid.innerHTML = ''; // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0:æ—¥, 1:æœˆ, ..., 6:åœŸ

            currentMonthYear.textContent = `${currentYear}å¹´${currentMonth + 1}æœˆ`;

            // å‰æœˆã®ç©ºç™½ã‚»ãƒ«
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'empty');
                calendarGrid.appendChild(emptyDay);
            }

            // ä»Šæœˆã®æ—¥ä»˜ã‚»ãƒ«
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day');
                dayElement.textContent = day;

                const fullDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // ä»Šæ—¥ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                const today = new Date();
                const todayFormatted = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                if (fullDate === todayFormatted) {
                    dayElement.classList.add('today');
                }

                // ãã®æ—¥ã«ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const tasksForDay = allTasksData.filter(task => task.dueDate === fullDate && !task.isCompleted);
                if (tasksForDay.length > 0) {
                    dayElement.classList.add('has-tasks');
                }

                dayElement.dataset.date = fullDate; // YYYY-MM-DDå½¢å¼ã§ãƒ‡ãƒ¼ã‚¿å±æ€§ã«ä¿å­˜

                dayElement.addEventListener('click', function() {
                    // ä»¥å‰é¸æŠã•ã‚Œã¦ã„ãŸæ—¥ä»˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                    const previouslySelected = document.querySelector('.calendar-day.selected');
                    if (previouslySelected) {
                        previouslySelected.classList.remove('selected');
                    }
                    // æ–°ã—ãé¸æŠã•ã‚ŒãŸæ—¥ä»˜ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
                    dayElement.classList.add('selected');
                    selectedDate = fullDate; // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã‚’æ›´æ–°
                    displayTasksForSelectedDate(selectedDate);
                });
                calendarGrid.appendChild(dayElement);
            }

            // åˆæœŸè¡¨ç¤ºã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
            if (!selectedDate) {
                const todayElement = calendarGrid.querySelector('.calendar-day.today');
                if (todayElement) {
                    todayElement.click(); // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¦é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                } else {
                    // ä»Šæ—¥ã®æ—¥ä»˜ãŒç¾åœ¨ã®æœˆã«ãªã„å ´åˆï¼ˆä¾‹: æœˆã‚’ç§»å‹•ã—ãŸå¾Œï¼‰ã¯ã€1æ—¥ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    const firstDayElement = calendarGrid.querySelector('.calendar-day:not(.empty)');
                    if (firstDayElement) {
                        firstDayElement.click();
                    }
                }
            } else {
                // æœˆã‚’ç§»å‹•ã—ãŸå¾Œã«ä»¥å‰é¸æŠã—ã¦ã„ãŸæ—¥ä»˜ã‚’å†é¸æŠã—ã‚ˆã†ã¨ã™ã‚‹
                const elementToSelect = calendarGrid.querySelector(`[data-date="${selectedDate}"]`);
                if (elementToSelect) {
                    elementToSelect.classList.add('selected');
                    displayTasksForSelectedDate(selectedDate); // å†åº¦è¡¨ç¤º
                } else {
                    // ä»¥å‰é¸æŠã—ã¦ã„ãŸæ—¥ä»˜ãŒç¾åœ¨ã®æœˆã«ãªã„å ´åˆã¯ä»Šæ—¥ã‚’é¸æŠ
                    const todayElement = calendarGrid.querySelector('.calendar-day.today');
                    if (todayElement) {
                        todayElement.click();
                    } else {
                        // ä»Šæ—¥ã‚‚ãªã„å ´åˆã¯1æ—¥ã‚’é¸æŠ
                        const firstDayElement = calendarGrid.querySelector('.calendar-day:not(.empty)');
                        if (firstDayElement) {
                            firstDayElement.click();
                        }
                    }
                }
            }
        }

        function displayTasksForSelectedDate(date) {
            selectedDateHeader.textContent = `${new Date(date).getFullYear()}å¹´${new Date(date).getMonth() + 1}æœˆ${new Date(date).getDate()}æ—¥ã®ã‚¿ã‚¹ã‚¯`;
            selectedDateTasksList.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢

            const tasksToShow = allTasksData.filter(task => task.dueDate === date);

            if (tasksToShow.length > 0) {
                noTasksMessage.style.display = 'none';
                // å®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯ã‚’æœ€å¾Œã«ã‚½ãƒ¼ãƒˆ
                tasksToShow.sort((a, b) => (a.isCompleted === b.isCompleted) ? 0 : a.isCompleted ? 1 : -1);

                tasksToShow.forEach(task => {
                    // LIè¦ç´ ã®HTMLã‚’ãã®ã¾ã¾æŒ¿å…¥
                    selectedDateTasksList.insertAdjacentHTML('beforeend', task.html);
                });
            } else {
                noTasksMessage.style.display = 'block';
            }
        }

        // æœˆç§»å‹•ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        prevMonthBtn.addEventListener('click', function() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            selectedDate = null; // æœˆç§»å‹•ã§é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            generateCalendar();
        });

        nextMonthBtn.addEventListener('click', function() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            selectedDate = null; // æœˆç§»å‹•ã§é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            generateCalendar();
        });

        // åˆæœŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆã¨é€šçŸ¥ãƒã‚§ãƒƒã‚¯
        generateCalendar();
        checkAndNotifyTasks();
        // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½ã®JavaScript çµ‚ã‚ã‚Š ---
      });
    </script>
  </body>
</html>